<!-- frontend/src/app/dashboard/dashboard.component.html -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-4">
  <div class="flex justify-content-between align-items-center mb-4">
    <h2 class="text-3xl font-bold">Your Dashboard</h2>
    <p-button label="Create New Post" icon="pi pi-plus" routerLink="/create-post"
      styleClass="p-button-success"></p-button>
  </div>

  <!-- Conditional display based on user role -->
  @if (currentUser() && (currentUser()?.role === 'AUTHOR' || currentUser()?.role === 'ADMIN')) {
  <p-card header="Your Posts" [style]="{'margin-bottom': '2em'}">
    <p-table [value]="userPosts()" [paginator]="true" [rows]="limit()" [totalRecords]="totalRecords()"
      [loading]="loadingPosts()" (onPage)="onPageChange($event)" [rowsPerPageOptions]="[5, 10, 20]"
      [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [tableStyle]="{'min-width': '50rem'}" [scrollable]="true" scrollHeight="400px">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%;">ID</th>
          <th style="width: 30%;">Title</th>
          <th style="width: 20%;">Category</th>
          <th style="width: 15%;">Status</th>
          <th style="width: 15%;">Created At</th>
          <th style="width: 15%;">Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-post>
        <tr>
          <td>{{ post.id.substring(0, 8) }}...</td>
          <td>{{ post.title }}</td>
          <td>{{ post.category }}</td>
          <td>
            <p-tag [value]="post.status" [severity]="post.status === 'PUBLISHED' ? 'success' : 'warning'"></p-tag>
          </td>
          <td>{{ post.createdAt | date:'shortDate' }}</td>
          <td>
            <p-button icon="pi pi-pencil" styleClass="p-button-rounded p-button-text p-button-info mr-2"
              [routerLink]="['/edit-post', post.id]" pTooltip="Edit Post" tooltipPosition="bottom"></p-button>
            <p-button icon="pi pi-trash" styleClass="p-button-rounded p-button-text p-button-danger"
              (click)="confirmDelete(post)" pTooltip="Delete Post" tooltipPosition="bottom"></p-button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">No posts found.</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
  } @else {
  <p-card header="Access Denied" [style]="{'margin-bottom': '2em'}">
    <div class="flex flex-column align-items-center justify-content-center p-5">
      <i class="pi pi-lock text-6xl text-400 mb-4"></i>
      <p class="text-xl text-center mb-4">You need to be an Author or Admin to manage posts.</p>
      <p class="text-lg text-center mb-4">
        Your current role is <span class="font-bold">{{ currentUser()?.role || 'Guest' }}</span>.
      </p>
      <!-- The "Request Author Role" button is now in the TopBarComponent -->
      <p class="text-sm text-center text-500">
        If you wish to become an author, please use the "Request Author Role" option in the top bar menu.
      </p>
    </div>
  </p-card>
  }
</div>